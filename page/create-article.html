<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="../assets/img/image.png" />
    <title>Create Article</title>

    <!-- Bootstrap & Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />

    <!-- Custom Styles -->
    <style>
      /* Sidebar */

      /* Main Content */

      /* Topbar */
      .topbar {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 2rem;
        position: relative;
      }

      .avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        object-fit: cover;
        cursor: pointer;
      }

      .profile-dropdown {
        position: absolute;
        top: 60px;
        right: 0;
        width: 180px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: none;
        z-index: 2000;
      }

      .profile-dropdown.show {
        display: block;
      }

      .profile-dropdown .dropdown-item {
        padding: 10px 15px;
        display: block;
        text-decoration: none;
        font-size: 14px;
        color: #333;
        cursor: pointer;
      }

      .profile-dropdown .dropdown-item:hover {
        background: #f2f2f2;
      }

      /* Logout Modal */
      .modal-backdrop-custom {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        z-index: 3000;
        animation: fadeIn 0.25s ease;
      }

      .custom-modal {
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        width: 350px;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 4000;
        text-align: center;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Card */
      .create-card {
        background: #fff;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        max-width: 900px;
        margin: 0 auto;
      }

      /* Buttons */
      .btn-publish {
        background: linear-gradient(90deg, #a855f7, #ec489a);
        color: #fff;
        font-weight: 600;
        border-radius: 8px;
        padding: 12px 20px;
        border: none;
        transition: all 0.25s ease;
      }
      .btn-publish:hover {
        background: linear-gradient(90deg, #9333ea, #db2777);
      }

      .btn-back {
        color: #6b7280;
        text-decoration: none;
        font-weight: 500;
      }
      .btn-back:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="../assets/img/image.png" alt="Logo" /> Blog Post
      </div>
      <ul class="menu-sidebar">
        <li>
          <a href="../index.html"><i class="bi bi-grid-fill"></i> Dashboard</a>
        </li>
        <li>
          <details open>
            <summary><i class="bi bi-file-text-fill"></i> My Articles</summary>
            <ul>
              <li><a href="own_article.html">All Articles</a></li>
              <li>
                <a href="create-article.html" class="menu-active"
                  >Create Article</a
                >
              </li>
            </ul>
          </details>
        </li>
        <li>
          <a href="categories.html"><i class="bi bi-tags-fill"></i> Category</a>
        </li>
      </ul>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Topbar -->
      <div class="topbar">
        <div class="profile-trigger" onclick="toggleDropdown()">
          <div class="me-2 text-end">
            <div class="fw-semibold" id="welcomeMessage"></div>
            <div class="email text-muted" id="email"></div>
          </div>
          <img id="avatar" class="avatar" src="" />
        </div>

        <div id="profileDropdown" class="profile-dropdown">
          <div
            class="dropdown-item"
            onclick="window.location.href='../page/profile.html'"
          >
            <i class="bi bi-person-circle me-2"></i> View Profile
          </div>
          <div class="dropdown-item text-danger" onclick="openLogoutModal()">
            <i class="bi bi-box-arrow-right me-2"></i> Logout
          </div>
        </div>
      </div>

      <!-- Create Article Form -->
      <div class="create-card">
        <h2>Create Article</h2>
        <p>Compose a new article and publish it to your platform.</p>

        <form id="articleForm" novalidate>
          <div class="mb-3">
            <label class="form-label">Title *</label>
            <input
              type="text"
              id="title"
              class="form-control"
              placeholder="Title of the article"
            />
            <div class="invalid-feedback" id="titleError" style="display: none">
              Title is required.
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Category *</label>
            <select id="categoryId" class="form-select">
              <option>Loading...</option>
            </select>
            <div
              class="invalid-feedback"
              id="categoryError"
              style="display: none"
            >
              Category is required.
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Thumbnail (Optional)</label>
            <input
              type="file"
              id="formFile"
              class="form-control"
              accept="image/*"
            />
          </div>

          <div class="mb-3">
            <label class="form-label">Content *</label>
            <textarea
              id="content"
              rows="8"
              class="form-control"
              placeholder="Write content here..."
            ></textarea>
            <div
              class="invalid-feedback"
              id="contentError"
              style="display: none"
            >
              Content must be at least 10 characters.
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center">
            <a href="own_article.html" class="btn-back"
              ><i class="bi bi-arrow-left"></i> Back to Articles</a
            >
            <button
              type="button"
              class="btn btn-publish"
              onclick="createArticle()"
            >
              Publish Now
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Logout Modal -->
    <div id="logoutModal" class="modal-backdrop-custom">
      <div class="custom-modal">
        <h4 class="mb-3">Logout Confirmation</h4>
        <p class="text-muted">Are you sure you want to logout?</p>
        <div class="d-flex gap-3 mt-4">
          <button class="btn btn-secondary w-50" onclick="closeLogoutModal()">
            Cancel
          </button>
          <button class="btn btn-danger w-50" onclick="confirmLogout()">
            Logout
          </button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      const token = localStorage.getItem("token");
      if (!token) window.location.href = "login.html";

      // Profile Dropdown
      function toggleDropdown() {
        document.getElementById("profileDropdown").classList.toggle("show");
      }
      document.addEventListener("click", (e) => {
        const dropdown = document.getElementById("profileDropdown");
        const trigger = document.querySelector(".profile-trigger");
        if (!trigger.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.remove("show");
        }
      });

      // Logout Modal
      function openLogoutModal() {
        document.getElementById("logoutModal").style.display = "block";
      }
      function closeLogoutModal() {
        document.getElementById("logoutModal").style.display = "none";
      }
      function confirmLogout() {
        localStorage.removeItem("token");
        window.location.href = "login.html";
      }

      document.addEventListener("DOMContentLoaded", async () => {
        // Load profile
        const profileRes = await fetch(
          "http://blogs.csm.linkpc.net/api/v1/auth/profile",
          {
            headers: { Authorization: `Bearer ${token}` },
          }
        );
        const profileData = await profileRes.json();
        const p = profileData.data;
        document.getElementById(
          "welcomeMessage"
        ).innerText = `Welcome, ${p.firstName} ${p.lastName}`;
        document.getElementById("email").innerText = p.email;
        document.getElementById("avatar").src =
          p.avatar || "../assets/img/default-avatar.jpg";

        // Load categories
        const categorySelect = document.getElementById("categoryId");
        const catRes = await fetch(
          "http://blogs.csm.linkpc.net/api/v1/categories?_per_page=100",
          {
            headers: { Authorization: `Bearer ${token}` },
          }
        );
        const catData = await catRes.json();
        categorySelect.innerHTML = '<option value="">Select Category</option>';
        catData.data.items.forEach((cat) => {
          const opt = document.createElement("option");
          opt.value = cat.id;
          opt.textContent = cat.name;
          categorySelect.appendChild(opt);
        });
      });

      // Create Article Function
      async function createArticle() {
        const titleEl = document.getElementById("title");
        const contentEl = document.getElementById("content");
        const categoryEl = document.getElementById("categoryId");
        const fileEl = document.getElementById("formFile");

        // Reset validation
        ["title", "content", "categoryId"].forEach((id) =>
          document.getElementById(id).classList.remove("is-invalid")
        );
        ["titleError", "categoryError", "contentError"].forEach(
          (id) => (document.getElementById(id).style.display = "none")
        );

        let valid = true;
        if (!titleEl.value.trim()) {
          document.getElementById("titleError").style.display = "block";
          titleEl.classList.add("is-invalid");
          valid = false;
        }
        if (!categoryEl.value) {
          document.getElementById("categoryError").style.display = "block";
          categoryEl.classList.add("is-invalid");
          valid = false;
        }
        if (contentEl.value.trim().length < 10) {
          document.getElementById("contentError").style.display = "block";
          contentEl.classList.add("is-invalid");
          valid = false;
        }
        if (!valid) return;

        try {
          // Create article
          const res = await fetch(
            "http://blogs.csm.linkpc.net/api/v1/articles",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                title: titleEl.value.trim(),
                content: contentEl.value.trim(),
                categoryId: Number(categoryEl.value),
              }),
            }
          );
          const data = await res.json();
          if (!data.data?.id)
            throw new Error(data.message || "Failed to create article");
          const articleId = data.data.id;

          // Upload thumbnail if exists
          if (fileEl.files.length > 0) {
            const formData = new FormData();
            formData.append("thumbnail", fileEl.files[0]);
            await fetch(
              `http://blogs.csm.linkpc.net/api/v1/articles/${articleId}/thumbnail`,
              {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
                body: formData,
              }
            );
          }

          window.location.href = "own_article.html";
        } catch (err) {
          console.error(err);
          alert(err.message || "An error occurred. Please try again.");
        }
      }
    </script>
  </body>
</html>
