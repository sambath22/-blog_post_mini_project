<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Categories</title>

    <!-- Bootstrap & Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/style.css" />

    <style>
      body {
        font-family: "Poppins", sans-serif;
      }

      /* Buttons */
      .btn-gradient,
      .create-btn {
        background: linear-gradient(90deg, #c084fc, #ec489a);
        color: #fff;
        border: none;
        padding: 10px 30px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      .btn-gradient:hover,
      .create-btn:hover {
        opacity: 0.9;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(236, 72, 154, 0.3);
      }

      /* Modals */
      .modal-backdrop-custom {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .custom-modal {
        background: #fff;
        padding: 25px;
        border-radius: 20px;
        width: 600px;
        max-width: 95%;
        box-shadow: 0 0 80px rgba(0, 0, 0, 0.3);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      /* Profile Dropdown */
      .profile-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        min-width: 180px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .profile-dropdown.show {
        display: block;
      }

      /* Toast Notification */
      .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #22c55e;
        color: #fff;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.4s ease, transform 0.4s ease;
        z-index: 9999;
      }
      .toast-notification.show {
        opacity: 1;
        transform: translateY(0);
      }

      /* Error messages */
      .text-error {
        color: #dc2626;
        font-size: 0.9rem;
        margin-top: 4px;
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="../assets/img/image.png" alt="Logo" /> Blog Post
      </div>
      <ul class="menu-sidebar">
        <li>
          <a href="../index.html"><i class="bi bi-grid-fill"></i> Dashboard</a>
        </li>
        <li>
          <details open>
            <summary><i class="bi bi-file-text-fill"></i> My Articles</summary>
            <ul>
              <li><a href="own_article.html">All Articles</a></li>
              <li>
                <a href="create-article.html" class="menu-active"
                  >Create Article</a
                >
              </li>
            </ul>
          </details>
        </li>
        <li>
          <a href="categories.html"><i class="bi bi-tags-fill"></i> Category</a>
        </li>
      </ul>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <div class="topbar">
        <div class="profile-dropdown-container position-relative">
          <div
            class="profile-trigger d-flex align-items-center"
            onclick="toggleDropdown()"
          >
            <div class="me-2 text-end">
              <div class="fw-semibold" id="welcomeMessage"></div>
              <div class="email text-muted" id="email"></div>
            </div>
            <img
              id="avatar"
              class="avatar rounded-circle"
              src=""
              width="40"
              height="40"
            />
          </div>
          <div id="profileDropdown" class="profile-dropdown shadow">
            <a href="../page/profile.html" class="dropdown-item"
              ><i class="bi bi-person-circle me-2"></i> View Profile</a
            >
            <button
              class="dropdown-item text-danger"
              onclick="openLogoutModal()"
            >
              <i class="bi bi-box-arrow-right me-2"></i> Logout
            </button>
          </div>
        </div>
      </div>

      <div class="content-wrapper">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="mb-0 fw-semibold text-purple">Categories</h3>
          <button class="btn create-btn" onclick="openCreateModal()">
            ➕ Create Category
          </button>
        </div>

        <input
          type="text"
          id="searchInput"
          class="form-control mb-3"
          placeholder="Search categories..."
          oninput="searchCategories()"
        />

        <table class="table table-bordered table-striped mt-3">
          <thead>
            <tr>
              <th>Category Name</th>
              <th class="text-end">Action</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Create Modal -->
    <div id="createModal" class="modal-backdrop-custom">
      <div class="custom-modal">
        <div class="modal-header">
          <h4>Create Category</h4>
          <button
            class="btn btn-outline-secondary"
            onclick="closeCreateModal()"
          >
            ✕
          </button>
        </div>
        <label class="form-label fw-semibold">Category Name *</label>
        <input id="createName" type="text" class="form-control mb-1" />
        <div id="createError" class="text-error">
          Category name cannot be empty!
        </div>
        <button class="btn w-100 create-btn mt-2" onclick="createCategory()">
          ➕ Create
        </button>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-backdrop-custom">
      <div class="custom-modal">
        <div class="modal-header">
          <h4>Edit Category</h4>
          <button class="btn btn-outline-secondary" onclick="closeEditModal()">
            ✕
          </button>
        </div>
        <label class="form-label fw-semibold">Category Name *</label>
        <input id="editName" type="text" class="form-control mb-1" />
        <div id="editError" class="text-error">
          Category name cannot be empty!
        </div>
        <button class="btn w-100 create-btn mt-2" onclick="updateCategory()">
          Save
        </button>
      </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal-backdrop-custom">
      <div class="custom-modal text-center">
        <h4 class="mb-3">Delete Confirmation</h4>
        <p class="text-muted">Are you sure you want to delete this category?</p>
        <div class="d-flex gap-3 mt-4">
          <button class="btn btn-secondary w-50" onclick="closeDeleteModal()">
            Cancel
          </button>
          <button id="confirmDeleteBtn" class="btn btn-danger w-50">
            Delete
          </button>
        </div>
      </div>
    </div>

    <!-- Logout Modal -->
    <div id="logoutModal" class="modal-backdrop-custom">
      <div class="custom-modal text-center">
        <h4 class="mb-3">Logout Confirmation</h4>
        <p class="text-muted">Are you sure you want to logout?</p>
        <div class="d-flex gap-3 mt-4">
          <button class="btn btn-secondary w-50" onclick="closeLogoutModal()">
            Cancel
          </button>
          <button class="btn btn-danger w-50" onclick="confirmLogout()">
            Logout
          </button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="successToast" class="toast-notification">
      <span id="successMessage"></span>
    </div>

    <script>
      const token = localStorage.getItem("token");
      let allCategories = [],
        selectedID = null,
        categoryToDelete = null;

      // Load Profile
      async function loadProfile() {
        try {
          const res = await fetch(
            "http://blogs.csm.linkpc.net/api/v1/auth/profile",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          const data = await res.json();
          const profile = data.data;
          document.getElementById(
            "welcomeMessage"
          ).innerText = `Welcome, ${profile.firstName} ${profile.lastName}`;
          document.getElementById("email").innerText = profile.email;
          document.getElementById("avatar").src =
            profile.avatar || "https://via.placeholder.com/150";
        } catch (err) {
          console.error(err);
        }
      }

      // Load Categories
      async function loadCategories() {
        try {
          const res = await fetch(
            "http://blogs.csm.linkpc.net/api/v1/categories?_page=1&_per_page=100",
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          const result = await res.json();
          allCategories = result.data?.items || [];
          displayCategories(allCategories);
        } catch (err) {
          console.error(err);
        }
      }

      function displayCategories(categories) {
        const tbody = document.getElementById("tbody");
        tbody.innerHTML = "";
        categories.forEach((cat) => {
          const row = document.createElement("tr");
          row.innerHTML = `
          <td>${cat.name}</td>
          <td class="text-end">
            <button class="btn bg-warning p-1 me-2" onclick="openEditModal('${cat.id}', '${cat.name}')">
              <i class="bi bi-pencil-square" style="font-size:18px;color:#404040;"></i>
            </button>
            <button class="btn bg-danger p-1" onclick="openDeleteModal('${cat.id}')">
              <i class="bi bi-trash3" style="font-size:18px;color:#404040;"></i>
            </button>
          </td>`;
          tbody.appendChild(row);
        });
      }

      function searchCategories() {
        const query = document
          .getElementById("searchInput")
          .value.toLowerCase();
        displayCategories(
          allCategories.filter((cat) => cat.name.toLowerCase().includes(query))
        );
      }

      // Profile Dropdown
      function toggleDropdown() {
        document.getElementById("profileDropdown").classList.toggle("show");
      }
      document.addEventListener("click", (e) => {
        const dropdown = document.getElementById("profileDropdown");
        const trigger = document.querySelector(".profile-trigger");
        if (!trigger.contains(e.target) && !dropdown.contains(e.target))
          dropdown.classList.remove("show");
      });

      // Logout
      function openLogoutModal() {
        document.getElementById("logoutModal").style.display = "flex";
      }
      function closeLogoutModal() {
        document.getElementById("logoutModal").style.display = "none";
      }
      function confirmLogout() {
        localStorage.removeItem("token");
        window.location.href = "login.html";
      }

      // Modals
      function openCreateModal() {
        document.getElementById("createModal").style.display = "flex";
      }
      function closeCreateModal() {
        document.getElementById("createModal").style.display = "none";
        document.getElementById("createName").value = "";
        document.getElementById("createError").style.display = "none";
      }
      function openEditModal(id, name) {
        selectedID = id;
        document.getElementById("editName").value = name;
        document.getElementById("editError").style.display = "none";
        document.getElementById("editModal").style.display = "flex";
      }
      function closeEditModal() {
        document.getElementById("editModal").style.display = "none";
      }
      function openDeleteModal(id) {
        categoryToDelete = id;
        document.getElementById("deleteModal").style.display = "flex";
      }
      function closeDeleteModal() {
        categoryToDelete = null;
        document.getElementById("deleteModal").style.display = "none";
      }

      // Toast
      function showToast(message, type = "success") {
        const toast = document.getElementById("successToast");
        toast.style.backgroundColor =
          type === "success" ? "#22c55e" : "#dc2626";
        document.getElementById("successMessage").innerText = message;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2000);
      }

      // CRUD
      async function createCategory() {
        const name = document.getElementById("createName").value.trim();
        const errorDiv = document.getElementById("createError");
        if (!name) {
          errorDiv.style.display = "block";
          return;
        }
        errorDiv.style.display = "none";
        try {
          const res = await fetch(
            "http://blogs.csm.linkpc.net/api/v1/categories",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ name }),
            }
          );
          const result = await res.json();
          if (!result.result)
            return showToast("Failed to create category!", "error");
          closeCreateModal();
          showToast("Category created successfully!");
          loadCategories();
        } catch (err) {
          console.error(err);
          showToast("Error creating category!", "error");
        }
      }

      async function updateCategory() {
        const newName = document.getElementById("editName").value.trim();
        const errorDiv = document.getElementById("editError");
        if (!newName) {
          errorDiv.style.display = "block";
          return;
        }
        errorDiv.style.display = "none";
        try {
          const res = await fetch(
            `http://blogs.csm.linkpc.net/api/v1/categories/${selectedID}`,
            {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ name: newName }),
            }
          );
          const result = await res.json();
          if (!result.result)
            return showToast("Failed to update category!", "error");
          closeEditModal();
          showToast("Category updated successfully!");
          loadCategories();
        } catch (err) {
          console.error(err);
          showToast("Error updating category!", "error");
        }
      }

      // Delete
      document
        .getElementById("confirmDeleteBtn")
        .addEventListener("click", async () => {
          if (!categoryToDelete) return;
          try {
            const res = await fetch(
              `http://blogs.csm.linkpc.net/api/v1/categories/${categoryToDelete}`,
              {
                method: "DELETE",
                headers: { Authorization: `Bearer ${token}` },
              }
            );
            const result = await res.json();
            if (!result.result)
              return showToast("Failed to delete category!", "error");
            closeDeleteModal();
            showToast("Category deleted successfully!");
            loadCategories();
          } catch (err) {
            console.error(err);
            showToast("Error deleting category!", "error");
          }
        });

      loadProfile();
      loadCategories();
    </script>
  </body>
</html>
